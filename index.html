<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ARCHITECT CHESS PRO</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Roboto+Mono&display=swap');
        :root { --p: #00d4ff; --bg: #0a0e17; --c: #141b26; --sl: #dee3e6; --sd: #769656; --gold: #ffd700; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Orbitron', sans-serif; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; touch-action: none; }
        
        .architect-tag { font-size: 24px; font-weight: 900; color: var(--p); text-shadow: 0 0 10px var(--p); letter-spacing: 4px; margin-top: 15px; text-transform: uppercase; }
        .credits { font-size: 9px; color: var(--p); letter-spacing: 3px; margin-bottom: 15px; opacity: 0.7; }

        img.piece { width: 90%; z-index: 5; pointer-events: none; filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); }
        .black { filter: invert(1) brightness(0.8) drop-shadow(0 0 2px var(--p)) !important; }

        .nav-ui { position: fixed; top: 15px; left: 15px; z-index: 110; display: flex; gap: 8px; }
        .btn-ui { background: rgba(0, 212, 255, 0.1); border: 1px solid var(--p); color: var(--p); padding: 8px 12px; border-radius: 8px; font-size: 10px; cursor: pointer; font-weight: bold; }
        .overlay { position: fixed; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; overflow-y: auto; text-align: center; }
        .auth-card { background: var(--c); padding: 25px; border-radius: 20px; width: 85%; max-width: 320px; border: 1px solid #222; }
        
        input, select { background: #000; border: 1px solid var(--p); color: white; padding: 12px; margin: 8px 0; width: 100%; text-align: center; border-radius: 8px; font-family: 'Roboto Mono'; outline: none; box-sizing: border-box; }
        .btn-main { width: 100%; padding: 14px; background: var(--p); color: #000; border: none; border-radius: 8px; font-family: 'Orbitron'; font-weight: 900; cursor: pointer; margin-top: 10px; }
        
        #social-panel { width: 90%; max-height: 200px; overflow-y: auto; background: #000; border: 1px solid #222; border-radius: 10px; margin-top: 10px; padding: 10px; display: none; }
        
        /* REPLAY SYSTEM */
        .replay-ctrl { display: flex; gap: 20px; margin-top: 10px; }
        .saved-item { background: #111; padding: 10px; margin: 5px; border-radius: 8px; border-left: 4px solid var(--p); display: flex; justify-content: space-between; align-items: center; }

        /* CERTIFICATE */
        #cert-overlay { display:none; background: rgba(0,0,0,0.9); padding: 10px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 200; width: 95%; max-width: 500px; }
        #cert-canvas-area { background: linear-gradient(135deg, #0a0e17 0%, #1a2533 100%); color: var(--gold); border: 8px double var(--gold); padding: 40px; text-align: center; position: relative; }
        .cert-header { font-size: 28px; font-weight: 900; margin-bottom: 20px; text-shadow: 0 0 10px var(--gold); border-bottom: 2px solid var(--gold); display: inline-block; }
        .cert-name { font-size: 32px; color: white; margin: 15px 0; text-transform: uppercase; font-weight: 900; text-decoration: underline; }
        .signature { font-family: 'cursive'; font-size: 20px; border-top: 1px solid var(--gold); padding-top: 5px; color: white; }

        .sq.hint::after { content: ''; width: 15px; height: 15px; background: var(--p); border-radius: 50%; opacity: 0.6; }
        .selected { background: rgba(0, 212, 255, 0.3) !important; }
        #board-box { margin: 10px 0; width: 92vw; max-width: 380px; aspect-ratio: 1/1; border: 6px solid var(--c); position: relative; border-radius: 12px; }
        #board { display: grid; grid-template-columns: repeat(8, 1fr); grid-template-rows: repeat(8, 1fr); height: 100%; }
        .sq { display: flex; justify-content: center; align-items: center; position: relative; }
        .sq.l { background: var(--sl); } .sq.d { background: var(--sd); }
        .hud { width: 100%; background: var(--c); padding: 15px; display: flex; justify-content: space-between; border-bottom: 2px solid var(--p); margin-top: 60px; font-size: 12px; font-weight: 900; }
    </style>
</head>
<body onclick="initAudio()">

    <div id="global-nav" class="nav-ui" style="display:none">
        <div class="btn-ui" onclick="confirmExit()">üè† HOME</div>
        <div class="btn-ui" id="mute-btn" onclick="toggleMute()">üîä SOUND</div>
        <div class="btn-ui" id="voice-call-btn" style="display:none" onclick="toggleVoice()">üéôÔ∏è VOICE: OFF</div>
    </div>

    <div id="auth-screen" class="overlay">
        <div class="architect-tag">ARCHITECT CHESS PRO</div>
        <div class="credits">DEVELOPED BY MAUTASIM</div>
        <div class="auth-card">
            <input type="text" id="user-in" placeholder="USERNAME">
            <input type="password" id="pass-in" placeholder="PASSKEY">
            <button class="btn-main" onclick="handleAuth('login')">LOGIN</button>
            <button class="btn-main" style="background:none; border:1px solid var(--p); color:var(--p)" onclick="handleAuth('signup')">SIGN UP</button>
            <div style="margin: 15px 0; border-top: 1px solid #333; padding-top: 10px;">
                <button class="btn-main" style="background:#444; color:#fff" onclick="bootGuest()">GUEST / OFFLINE BOOT</button>
            </div>
        </div>
    </div>

    <div id="home-screen" class="overlay" style="display:none">
        <div class="architect-tag">ARCHITECT CHESS PRO</div>
        <div id="user-display" style="font-size: 10px; color: var(--p); margin-bottom: 10px;">USER: ---</div>
        <div class="dashboard" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 90%;">
            <div onclick="prepareGame('bot')" style="background:var(--c); padding:15px 5px; border-radius:12px; border:1px solid #333; cursor:pointer"><span>NEURAL AI</span></div>
            <div onclick="prepareGame('pass')" style="background:var(--c); padding:15px 5px; border-radius:12px; border:1px solid #333; cursor:pointer"><span>LOCAL PASS</span></div>
            <div onclick="showGallery()" style="background:var(--c); padding:15px 5px; border-radius:12px; border:1px solid var(--p); cursor:pointer"><span style="color:var(--p)">GALLERY & SAVED</span></div>
            <div id="social-node" onclick="toggleSocial()" style="background:var(--c); padding:15px 5px; border-radius:12px; border:1px solid #333; cursor:pointer"><span>SOCIAL HUB</span></div>
            <div onclick="doLogout()" style="grid-column: span 2; background:rgba(244,67,54,0.1); padding:10px; border-radius:12px; border:1px solid #f44336; cursor:pointer"><span>EXIT HUB</span></div>
        </div>
        <div id="social-panel">
            <input type="text" id="friend-id" placeholder="FRIEND ID">
            <button class="btn-main" style="padding: 5px; font-size: 9px;" onclick="addFriend()">ADD FRIEND</button>
            <div id="friends-list"></div>
        </div>
    </div>

    <div id="gallery-screen" class="overlay" style="display:none">
        <div class="architect-tag">DATA VAULT</div>
        <div style="width:90%; flex:1; overflow-y:auto;" id="gallery-content"></div>
        <button class="btn-main" style="width:200px; margin-bottom:20px;" onclick="showDashboard()">BACK</button>
    </div>

    <div id="cert-overlay">
        <div id="cert-canvas-area">
            <div class="cert-header">ARCHITECT MASTERY</div>
            <div class="cert-body">
                <p style="font-size: 10px;">THIS SUPREME PROTOCOL CONFIRMS THAT</p>
                <div class="cert-name" id="cert-name">PLAYER</div>
                <p style="font-size: 11px;">HAS DECIMATED THE ARCHITECT NEURAL ENGINE</p>
            </div>
            <div class="cert-footer" style="display:flex; justify-content:space-between; align-items:flex-end; font-size:10px; margin-top:20px;">
                <div style="text-align:left">ID: <span id="cert-id">#0000</span><br><span id="cert-date">2024</span></div>
                <div><div class="signature">Mautasim</div><div style="font-size:7px">CHIEF ARCHITECT</div></div>
            </div>
        </div>
        <button class="btn-main" onclick="downloadCert()">DOWNLOAD PNG</button>
        <button class="btn-main" style="background:#444" onclick="document.getElementById('cert-overlay').style.display='none'">CLOSE</button>
    </div>

    <div id="win-screen" class="overlay" style="display:none">
        <div class="architect-tag">CHECKMATE</div>
        <div id="winner-text" style="font-size: 20px; color: var(--p);">---</div>
        <button id="cert-btn" class="btn-main" style="display:none; background:var(--gold)" onclick="claimCert()">CLAIM CERTIFICATE</button>
        <button class="btn-main" onclick="saveMatch()">üíæ SAVE MATCH DATA</button>
        <button class="btn-main" style="background:#444" onclick="showDashboard()">EXIT</button>
    </div>

    <div class="hud">
        <div id="p1-label">---</div>
        <div id="p2-label" style="text-align:right">---</div>
    </div>
    <div id="board-box"><div id="board"></div></div>
    
    <div id="replay-ui" class="replay-ctrl" style="display:none">
        <button class="btn-ui" onclick="replayMove(-1)">‚¨ÖÔ∏è PREV</button>
        <button class="btn-ui" onclick="replayMove(1)">NEXT ‚û°Ô∏è</button>
    </div>

<script>
    const game = new Chess();
    const boardEl = document.getElementById('board');
    let currentUser = null, currentMode = 'bot', selectedSq = null, audioCtx = null, muted = false;
    let peer = null, conn = null, aiDifficulty = 'architect', playerColor = 'w', isGuest = false;
    let localStream = null, remoteAudio = new Audio();
    let moveHistory = [], historyIndex = -1;

    function initAudio() { if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function toggleMute() { muted = !muted; document.getElementById('mute-btn').innerText = muted ? "üîá MUTED" : "üîä SOUND"; }
    function playSound(f) { if(muted || !audioCtx) return; const o = audioCtx.createOscillator(), g = audioCtx.createGain(); o.connect(g); g.connect(audioCtx.destination); o.frequency.value = f; g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1); o.start(); o.stop(audioCtx.currentTime + 0.1); }

    function bootGuest() {
        isGuest = true; currentUser = "GUEST_" + Math.floor(Math.random()*1000);
        showDashboard();
    }

    function handleAuth(type) {
        const u = document.getElementById('user-in').value.trim().toUpperCase();
        const p = document.getElementById('pass-in').value.trim();
        if(!u || !p) return;
        const storedPass = localStorage.getItem('pwd_' + u);
        if(type === 'signup') {
            if(storedPass) { alert("ID TAKEN"); return; }
            localStorage.setItem('pwd_' + u, p); alert("ACCOUNT SECURED");
        } else {
            if(!storedPass || storedPass !== p) { alert("ACCESS DENIED"); return; }
        }
        isGuest = false; currentUser = u; localStorage.setItem('arch_user', u); initPeer(); showDashboard();
    }

    function initPeer() {
        if(isGuest || peer) return;
        peer = new Peer('ARCH-' + currentUser);
        peer.on('connection', c => { 
            conn = c; currentMode = 'online'; playerColor = 'b'; setupConnection(); 
            startGame();
        });
        peer.on('call', call => {
            navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                localStream = stream;
                call.answer(stream);
                call.on('stream', rs => { remoteAudio.srcObject = rs; remoteAudio.play().catch(e=>console.log("Audio Play Blocked")); });
                document.getElementById('voice-call-btn').innerText = "üéôÔ∏è VOICE: ON";
            });
        });
    }

    function toggleVoice() {
        if(!conn) return;
        if(localStream) {
            localStream.getTracks().forEach(t => t.stop()); localStream = null;
            document.getElementById('voice-call-btn').innerText = "üéôÔ∏è VOICE: OFF";
        } else {
            navigator.mediaDevices.getUserMedia({audio: true}).then(stream => {
                localStream = stream; const call = peer.call(conn.peer, stream);
                call.on('stream', rs => { remoteAudio.srcObject = rs; remoteAudio.play(); });
                document.getElementById('voice-call-btn').innerText = "üéôÔ∏è VOICE: ON";
            });
        }
    }

    function aiMove() {
        const moves = game.moves(); if(!moves.length) return;
        game.move(moves[Math.floor(Math.random()*moves.length)]);
        render();
    }

    function handleInput(id) {
        if (currentMode === 'replay') return;
        if (selectedSq) {
            const move = game.move({ from: selectedSq, to: id, promotion: 'q' });
            if (move) {
                playSound(400); selectedSq = null; render();
                if (currentMode === 'online' && conn) conn.send({ type: 'move', data: move });
                if (currentMode === 'bot') setTimeout(aiMove, 300);
                return;
            }
        }
        const p = game.get(id); if (p && p.color === game.turn()) { selectedSq = id; render(); }
    }

    function showDashboard() {
        document.querySelectorAll('.overlay').forEach(o => o.style.display='none');
        document.getElementById('home-screen').style.display = 'flex';
        document.getElementById('user-display').innerText = "USER: " + currentUser;
        document.getElementById('social-node').style.display = isGuest ? 'none' : 'block';
        document.getElementById('replay-ui').style.display = 'none';
        document.getElementById('global-nav').style.display = 'none';
    }

    function prepareGame(mode) {
        currentMode = mode;
        if(mode === 'bot') { playerColor = 'w'; startGame(); }
        else { startGame(); }
    }

    function startGame() {
        document.querySelectorAll('.overlay').forEach(o => o.style.display='none');
        document.getElementById('global-nav').style.display = 'flex';
        game.reset(); initBoard();
    }

    function initBoard() {
        boardEl.innerHTML = '';
        for (let i = 0; i < 64; i++) {
            const sq = document.createElement('div');
            sq.className = `sq ${(Math.floor(i/8) + i%8) % 2 === 0 ? 'l' : 'd'}`;
            sq.dataset.id = String.fromCharCode(97 + (i%8)) + (8 - Math.floor(i/8));
            sq.onclick = () => handleInput(sq.dataset.id); boardEl.appendChild(sq);
        }
        render();
    }

    function render() {
        document.querySelectorAll('.sq').forEach(s => {
            const p = game.get(s.dataset.id); s.innerHTML = '';
            s.classList.remove('selected', 'hint');
            if(s.dataset.id === selectedSq) s.classList.add('selected');
            if (p) {
                const img = document.createElement('img');
                img.src = `https://raw.githubusercontent.com/lichess-org/lila/master/public/piece/alpha/${p.color}${p.type.toUpperCase()}.svg`;
                img.className = 'piece' + (p.color === 'b' ? ' black' : ''); s.appendChild(img);
            }
        });
        if(game.game_over() && currentMode !== 'replay') {
            document.getElementById('win-screen').style.display = 'flex';
            document.getElementById('winner-text').innerText = game.in_checkmate() ? "CHECKMATE" : "DRAW";
            if(game.in_checkmate() && game.turn() === 'b' && !isGuest) document.getElementById('cert-btn').style.display = 'block';
        }
    }

    // SAVING AND REPLAY LOGIC
    function saveMatch() {
        const pgn = game.pgn();
        let history = JSON.parse(localStorage.getItem('matches_' + currentUser) || "[]");
        history.push({ pgn: pgn, date: new Date().toLocaleString() });
        localStorage.setItem('matches_' + currentUser, JSON.stringify(history));
        alert("MATCH SAVED TO DATA VAULT");
    }

    function showGallery() {
        document.querySelectorAll('.overlay').forEach(o => o.style.display='none');
        const content = document.getElementById('gallery-content');
        content.innerHTML = '<h3 style="color:var(--gold)">CERTIFICATES</h3>';
        
        let certs = JSON.parse(localStorage.getItem('gallery_' + currentUser) || "[]");
        certs.forEach(c => {
            content.innerHTML += `<div class="saved-item"><span>${c.id} - ${c.date}</span><button class="btn-ui" onclick="viewCert('${c.timestamp}')">VIEW</button></div>`;
        });

        content.innerHTML += '<h3 style="color:var(--p); margin-top:20px;">SAVED MATCHES</h3>';
        let matches = JSON.parse(localStorage.getItem('matches_' + currentUser) || "[]");
        matches.forEach((m, idx) => {
            content.innerHTML += `<div class="saved-item"><span>${m.date}</span><button class="btn-ui" onclick="startReplay(${idx})">REPLAY</button></div>`;
        });

        document.getElementById('gallery-screen').style.display = 'flex';
    }

    function startReplay(idx) {
        let matches = JSON.parse(localStorage.getItem('matches_' + currentUser) || "[]");
        const match = matches[idx];
        game.load_pgn(match.pgn);
        moveHistory = game.history({ verbose: true });
        game.reset();
        historyIndex = -1;
        currentMode = 'replay';
        document.getElementById('replay-ui').style.display = 'flex';
        startGame();
    }

    function replayMove(dir) {
        if(dir === 1 && historyIndex < moveHistory.length - 1) {
            historyIndex++; game.move(moveHistory[historyIndex]);
        } else if(dir === -1 && historyIndex >= 0) {
            game.undo(); historyIndex--;
        }
        render();
    }

    function claimCert() {
        const cert = { name: currentUser, date: new Date().toLocaleDateString(), id: "#"+Math.floor(Math.random()*9000), timestamp: Date.now() };
        let gallery = JSON.parse(localStorage.getItem('gallery_' + currentUser) || "[]");
        gallery.push(cert); localStorage.setItem('gallery_' + currentUser, JSON.stringify(gallery));
        viewCert(cert.timestamp);
    }

    function viewCert(ts) {
        let certs = JSON.parse(localStorage.getItem('gallery_' + currentUser) || "[]");
        const c = certs.find(x => x.timestamp == ts);
        document.getElementById('cert-name').innerText = c.name;
        document.getElementById('cert-id').innerText = c.id;
        document.getElementById('cert-date').innerText = c.date;
        document.getElementById('cert-overlay').style.display = 'block';
    }

    function downloadCert() {
        html2canvas(document.getElementById('cert-canvas-area')).then(c => {
            const a = document.createElement('a'); a.download = 'ArchitectCert.png'; a.href = c.toDataURL(); a.click();
        });
    }

    function confirmExit() { if(confirm("ABORT?")) showDashboard(); }
    function doLogout() { localStorage.removeItem('arch_user'); location.reload(); }

    window.onload = () => {
        const saved = localStorage.getItem('arch_user');
        if(saved) { currentUser = saved; initPeer(); showDashboard(); }
    };
</script>
</body>
</html>
