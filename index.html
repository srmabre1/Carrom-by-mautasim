<!DOCTYPE html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
    <title>ARCHITECT CHESS PRO - PERFECT EDITION üíØ</title> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script> 
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script> 
    <style> 
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Roboto+Mono&display=swap'); 
        :root {  
            --p: #00d4ff;  
            --bg: #0a0e17;  
            --c: #141b26;  
            --sl: #dee3e6;  
            --sd: #769656;  
            --error: #ff4d4d; 
            --success: #4dff4d; 
        } 
        body {  
            margin: 0;  
            background: var(--bg);  
            color: white;  
            font-family: 'Orbitron', sans-serif;  
            display: flex;  
            flex-direction: column;  
            align-items: center;  
            height: 100vh;  
            overflow: hidden;  
            touch-action: none;  
        } 
         
        .architect-tag {  
            font-size: 24px;  
            font-weight: 900;  
            color: var(--p);  
            text-shadow: 0 0 10px var(--p);  
            letter-spacing: 4px;  
            margin-top: 15px;  
            text-transform: uppercase;  
        } 
        .credits {  
            font-size: 9px;  
            color: var(--p);  
            letter-spacing: 3px;  
            margin-bottom: 15px;  
            opacity: 0.7;  
            animation: blink 2s infinite;  
        } 
        @keyframes blink { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } } 
 
        img.piece {  
            width: 90%;  
            z-index: 5;  
            pointer-events: none;  
            filter: drop-shadow(0 0 2px rgba(255,255,255,0.5));  
        } 
        .black {  
            filter: invert(1) brightness(0.8) drop-shadow(0 0 2px var(--p)) !important;  
        } 
 
        .nav-ui {  
            position: fixed;  
            top: 15px;  
            left: 15px;  
            z-index: 110;  
            display: flex;  
            gap: 8px;  
        } 
        .btn-ui {  
            background: rgba(0, 212, 255, 0.1);  
            border: 1px solid var(--p);  
            color: var(--p);  
            padding: 8px 12px;  
            border-radius: 8px;  
            font-size: 10px;  
            cursor: pointer;  
            font-weight: bold;  
            transition: all 0.2s ease; 
        } 
        .btn-ui:hover { background: rgba(0, 212, 255, 0.2); } 
        .overlay {  
            position: fixed;  
            inset: 0;  
            background: var(--bg);  
            display: flex;  
            flex-direction: column;  
            align-items: center;  
            justify-content: center;  
            z-index: 100;  
            overflow-y: auto;  
            text-align: center;  
        } 
        .auth-card {  
            background: var(--c);  
            padding: 25px;  
            border-radius: 20px;  
            width: 85%;  
            max-width: 320px;  
            border: 1px solid #222;  
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);  
        } 
         
        input, select {  
            background: #000;  
            border: 1px solid var(--p);  
            color: white;  
            padding: 12px;  
            margin: 8px 0;  
            width: 100%;  
            text-align: center;  
            border-radius: 8px;  
            font-family: 'Roboto Mono';  
            outline: none;  
            box-sizing: border-box;  
        } 
        .btn-main {  
            width: 100%;  
            padding: 14px;  
            background: var(--p);  
            color: #000;  
            border: none;  
            border-radius: 8px;  
            font-family: 'Orbitron';  
            font-weight: 900;  
            cursor: pointer;  
            margin-top: 10px;  
            transition: all 0.2s ease; 
            position: relative; 
        } 
        .btn-main:hover { transform: scale(1.02); } 
        .btn-main:disabled { opacity: 0.6; cursor: not-allowed; } 
         
        #social-panel {  
            width: 90%;  
            max-height: 200px;  
            overflow-y: auto;  
            background: #000;  
            border: 1px solid #222;  
            border-radius: 10px;  
            margin-top: 15px;  
            padding: 10px;  
            display: none;  
        } 
        .friend-item {  
            padding: 8px;  
            border-bottom: 1px solid #111;  
            font-size: 10px;  
            display: flex;  
            justify-content: space-between;  
            cursor: pointer;  
            transition: background 0.2s; 
        } 
        .friend-item:hover { background: rgba(0,212,255,0.1); } 
         
        #chat-window {  
            position: fixed;  
            bottom: 10px;  
            right: 10px;  
            width: 250px;  
            height: 300px;  
            background: var(--c);  
            border: 1px solid var(--p);  
            display: none;  
            flex-direction: column;  
            z-index: 120;  
            border-radius: 10px;  
        } 
        #chat-msgs {  
            flex: 1;  
            overflow-y: auto;  
            padding: 10px;  
            font-size: 11px;  
            text-align: left;  
        } 
 
        .sq.hint::after {  
            content: '';  
            width: 15px;  
            height: 15px;  
            background: var(--p);  
            border-radius: 50%;  
            opacity: 0.6;  
        } 
        .selected {  
            background: rgba(0, 212, 255, 0.3) !important;  
        } 
        #board-box {  
            margin: 10px 0;  
            width: 92vw;  
            max-width: 380px;  
            aspect-ratio: 1/1;  
            border: 6px solid var(--c);  
            position: relative;  
            border-radius: 12px;  
        } 
        #board {  
            display: grid;  
            grid-template-columns: repeat(8, 1fr);  
            grid-template-rows: repeat(8, 1fr);  
            height: 100%;  
        } 
        .sq {  
            display: flex;  
            justify-content: center;  
            align-items: center;  
            position: relative;  
            transition: all 0.2s ease; 
        } 
        .sq.l { background: var(--sl); }  
        .sq.d { background: var(--sd); } 
        .hud {  
            width: 100%;  
            background: var(--c);  
            padding: 15px;  
            display: flex;  
            justify-content: space-between;  
            border-bottom: 2px solid var(--p);  
            margin-top: 60px;  
            font-size: 12px;  
            font-weight: 900;  
        } 
         
        /* Draw/Resign buttons */ 
        .draw-resign {  
            position: absolute;  
            top: 10px;  
            right: 10px;  
            z-index: 100;  
            display: flex;  
            gap: 5px;  
        } 
        .btn-draw {  
            background: #ffd700;  
            color: #000;  
            padding: 5px 10px;  
            border-radius: 4px;  
            font-size: 10px;  
            cursor: pointer;  
            border: none; 
        } 
        .btn-resign {  
            background: #ff4d4d;  
            color: white;  
            padding: 5px 10px;  
            border-radius: 4px;  
            font-size: 10px;  
            cursor: pointer;  
            border: none; 
        } 
         
        /* Board customization */ 
        .theme-selector {  
            position: fixed;  
            bottom: 10px;  
            left: 10px;  
            z-index: 100;  
            background: var(--c);  
            padding: 10px;  
            border-radius: 8px;  
            border: 1px solid var(--p);  
        } 
        .theme-selector select {  
            background: #000;  
            color: white;  
            padding: 5px;  
            border: 1px solid var(--p);  
            border-radius: 4px;  
        } 
         
        /* Loading spinner */ 
        .spinner {  
            width: 20px;  
            height: 20px;  
            border: 2px solid #333;  
            border-top: 2px solid var(--p);  
            border-radius: 50%;  
            animation: spin 1s linear infinite;  
            display: inline-block;  
            margin-left: 10px;  
        } 
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } } 
         
        /* Status messages */ 
        .status-msg {  
            font-size: 12px;  
            margin-top: 10px;  
            padding: 8px;  
            border-radius: 4px;  
            display: none;  
        } 
        .status-error { background: rgba(255,77,77,0.2); color: var(--error); border: 1px solid var(--error); } 
        .status-success { background: rgba(77,255,77,0.2); color: var(--success); border: 1px solid var(--success); } 
         
        /* Smooth animations for mobile */ 
        .sq.selected, .sq.hint { 
            transition: background-color 0.2s ease-out, transform 0.1s ease-in; 
            transform: scale(1.05); 
        } 
        .sq:hover:not(.selected) { 
            background-color: rgba(0, 212, 255, 0.1); 
        } 
        /* Lazy load images */ 
        img.piece { 
            width: 90%; 
            z-index: 5; 
            pointer-events: none; 
            filter: drop-shadow(0 0 2px rgba(255,255,255,0.5)); 
            transition: opacity 0.3s ease-in-out; 
        } 
        img.piece.black { 
            filter: invert(1) brightness(0.8) drop-shadow(0 0 2px var(--p)) !important; 
        } 
        /* Better mobile touch targets */ 
        @media (max-width: 600px) { 
            .sq { 
                min-height: 40px; 
                font-size: 12px; 
            } 
            #board-box { 
                width: 95vw; 
                max-width: none; 
            } 
            .btn-ui, .btn-main { 
                padding: 6px 10px; 
                font-size: 8px; 
            } 
        } 
    </style> 
</head> 
<body onclick="initAudio()"> 
 
    <div id="global-nav" class="nav-ui" style="display:none"> 
        <div class="btn-ui" onclick="confirmExit()">üè† HOME</div> 
        <div class="btn-ui" id="mute-btn" onclick="toggleMute()">üîä SOUND</div> 
    </div> 
 
    <div id="auth-screen" class="overlay"> 
        <div class="architect-tag">ARCHITECT PRO</div> 
        <div class="credits">DEVELOPED BY MAUTASIM - PERFECT EDITION üíØ</div> 
        <div class="auth-card"> 
            <input type="text" id="user-in" placeholder="USERNAME (3+ chars)" maxlength="20"> 
            <input type="password" id="pass-in" placeholder="PASSKEY (6+ chars)" maxlength="50"> 
            <button class="btn-main" id="login-btn" onclick="handleAuth('login')">LOGIN</button> 
            <button class="btn-main" style="background:none; border:1px solid var(--p); color:var(--p)" id="signup-btn" onclick="handleAuth('signup')">SIGN UP</button> 
            <div id="auth-status" class="status-msg"></div> 
        </div> 
    </div> 
 
    <div id="home-screen" class="overlay" style="display:none"> 
        <div class="architect-tag" id="user-display">---</div> 
        <div class="credits">DEVELOPED BY MAUTASIM - PERFECT EDITION üíØ</div> 
        <div class="dashboard" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; width: 90%;"> 
            <div onclick="prepareGame('bot')" style="background:var(--c); padding:20px 10px; border-radius:12px; border:1px solid #333; cursor:pointer; transition: all 0.2s;"><span>ü§ñ NEURAL AI</span></div> 
            <div onclick="prepareGame('pass')" style="background:var(--c); padding:20px 10px; border-radius:12px; border:1px solid #333; cursor:pointer; transition: all 0.2s;"><span>üë• LOCAL PASS</span></div> 
            <div onclick="toggleSocial()" style="background:var(--c); padding:20px 10px; border-radius:12px; border:1px solid #333; cursor:pointer; transition: all 0.2s;"><span>üåê SOCIAL HUB</span></div> 
            <div onclick="doLogout()" style="background:var(--c); padding:20px 10px; border-radius:12px; border:1px solid #f44336; cursor:pointer; transition: all 0.2s;"><span>üö™ LOGOUT</span></div> 
        </div> 
        <div id="social-panel"> 
            <input type="text" id="friend-id" placeholder="ENTER FRIEND ID (e.g. ARCH-PLAYER)" maxlength="20"> 
            <button class="btn-main" style="padding: 5px; font-size: 9px;" onclick="addFriend()">ADD FRIEND</button> 
            <div id="friends-list"></div> 
            <div id="connection-status" class="status-msg" style="margin-top: 10px;"></div> 
        </div> 
    </div> 
 
    <div id="ai-setup" class="overlay" style="display:none"> 
        <div class="auth-card"> 
            <h3 style="color:var(--p); font-size:14px;">NEURAL OVERRIDE</h3> 
            <select id="ai-level-select"> 
                <option value="architect">‚ö° LVL: ARCHITECT (WORLD'S HARDEST)</option> 
                <option value="casual">üòä LVL: CASUAL</option> 
            </select> 
            <button class="btn-main" onclick="startAI()">ENGAGE AI</button> 
            <button class="btn-main" style="background:none; border:1px solid #444; color:#777" onclick="showDashboard()">BACK</button> 
        </div> 
    </div> 
 
    <div id="pass-setup" class="overlay" style="display:none"> 
        <div class="auth-card"> 
            <h3 style="color:var(--p); font-size:14px;">PASS & PLAY SETUP</h3> 
            <input type="text" id="p1-in" placeholder="PLAYER 1 (WHITE)" value=""> 
            <input type="text" id="p2-in" placeholder="PLAYER 2 (BLACK)" value=""> 
            <button class="btn-main" onclick="startPass()">START MATCH</button> 
            <button class="btn-main" style="background:none; border:1px solid #444; color:#777" onclick="showDashboard()">BACK</button> 
        </div> 
    </div> 
 
    <div id="win-screen" class="overlay" style="display:none"> 
        <div class="architect-tag">CHECKMATE</div> 
        <div id="winner-text" style="font-size: 20px; color: var(--p); margin-top:10px;">---</div> 
        <div class="credits" style="margin-top:20px">DEVELOPED BY MAUTASIM - PERFECT EDITION üíØ</div> 
        <button class="btn-main" style="width:200px" onclick="showDashboard()">EXIT TO HUB</button> 
    </div> 
 
    <div id="chat-window"> 
        <div style="padding: 5px; border-bottom: 1px solid var(--p); font-size: 10px;"> 
            CHAT: <span id="chatting-with"></span>  
            <button onclick="closeChat()" style="float:right; background:none; color:red; border:none; cursor:pointer;">X</button> 
        </div> 
        <div id="chat-msgs"></div> 
        <input type="text" id="chat-input" placeholder="Type message..." onkeydown="if(event.key==='Enter') sendChat()"> 
    </div> 
 
    <div class="hud"> 
        <div id="p1-label">---</div> 
        <div style="color:var(--p)">VS</div> 
        <div id="p2-label" style="text-align:right">---</div> 
    </div> 
    <div id="board-box"><div id="board"></div></div> 
 
    <!-- Theme Selector --> 
    <div class="theme-selector"> 
        <label>Theme:</label> 
        <select onchange="applyTheme(this.value)"> 
            <option value="default">Default</option> 
            <option value="wood">Wood</option> 
            <option value="blue">Blue</option> 
            <option value="green">Green</option> 
        </select> 
    </div> 
 
<script> 
    const game = new Chess(); 
    const boardEl = document.getElementById('board'); 
    let currentUser = null, currentMode = 'bot', selectedSq = null, audioCtx = null, muted = false; 
    let peer = null, conn = null, aiDifficulty = 'architect', playerColor = 'w'; 
    let isConnected = false; 
 
    // Initialize Audio Context 
    function initAudio() {  
        if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();  
    } 
     
    function toggleMute() {  
        muted = !muted;  
        document.getElementById('mute-btn').innerText = muted ? "üîá MUTED" : "üîä SOUND";  
    } 
     
    // Optimized playSound with error handling 
    function playSound(frequency, duration = 0.1) { 
        if(muted || !audioCtx) return; 
        try { 
            const oscillator = audioCtx.createOscillator(); 
            const gainNode = audioCtx.createGain(); 
            oscillator.connect(gainNode); 
            gainNode.connect(audioCtx.destination); 
            oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime); 
            gainNode.gain.setValueAtTime(0.001, audioCtx.currentTime); 
            gainNode.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration); 
            oscillator.start(); 
            oscillator.stop(audioCtx.currentTime + duration); 
        } catch(e) { 
            console.error('Audio failed:', e); 
        } 
    } 
 
    // PERFECT LOGIN SYSTEM - Fixed and Secure 
    function handleAuth(type) { 
        const u = document.getElementById('user-in').value.trim().toUpperCase(); 
        const p = document.getElementById('pass-in').value.trim(); 
        const statusEl = document.getElementById('auth-status'); 
        const loginBtn = document.getElementById('login-btn'); 
        const signupBtn = document.getElementById('signup-btn'); 
        const loginSpinner = document.getElementById('login-spinner'); 
        const signupSpinner = document.getElementById('signup-spinner'); 
 
        // Clear previous status 
        statusEl.style.display = 'none'; 
        statusEl.className = 'status-msg'; 
 
        // Basic validation 
        if(!u || !p) {  
            showStatus('Both username and password are required.', 'error'); 
            return;  
        } 
        if(u.length < 3) {  
            showStatus('Username must be at least 3 characters.', 'error'); 
            return;  
        } 
        if(p.length < 6) {  
            showStatus('Password must be at least 6 characters.', 'error'); 
            return;  
        } 
 
        // Show loading 
        if(type === 'login') { 
            loginBtn.disabled = true; 
            loginSpinner.style.display = 'inline-block'; 
            loginBtn.innerHTML = 'LOGGING IN...'; 
        } else { 
            signupBtn.disabled = true; 
            signupSpinner.style.display = 'inline-block'; 
            signupBtn.innerHTML = 'CREATING...'; 
        } 
 
        // Hash password for security 
        const hashPass = CryptoJS.SHA256(p).toString(); 
 
        try { 
            // Check storage availability 
            if(!localStorage) { 
                throw new Error('Local storage not available'); 
            } 
 
            const storedHash = localStorage.getItem('pwd_' + u); 
             
            if(type === 'signup') { 
                if(storedHash) {  
                    showStatus('Username already taken. Please choose another.', 'error'); 
                    resetButtons(loginBtn, signupBtn, loginSpinner, signupSpinner, type); 
                    return;  
                } 
                // Create account 
                localStorage.setItem('pwd_' + u, hashPass); 
                localStorage.setItem('arch_user', u); 
                currentUser = u; 
                showStatus('Account created successfully! Welcome to ARCHITECT PRO üíØ', 'success'); 
                setTimeout(() => { 
                    initPeer(); 
                    showDashboard(); 
                }, 1500); 
            } else { 
                // Login 
                if(!storedHash || storedHash !== hashPass) {  
                    showStatus('Invalid username or password. Please try again.', 'error'); 
                    resetButtons(loginBtn, signupBtn, loginSpinner, signupSpinner, type); 
                    return;  
                } 
                localStorage.setItem('arch_user', u); 
                currentUser = u; 
                showStatus('Login successful! Welcome back to ARCHITECT PRO üíØ', 'success'); 
                setTimeout(() => { 
                    initPeer(); 
                    showDashboard(); 
                }, 1000); 
            } 
        } catch(e) { 
            console.error('Auth error:', e); 
            showStatus('Storage error occurred. Please check browser settings or clear cache.', 'error'); 
            resetButtons(loginBtn, signupBtn, loginSpinner, signupSpinner, type); 
        } 
    } 
 
    function showStatus(message, type) { 
        const statusEl = document.getElementById('auth-status'); 
        statusEl.textContent = message; 
        statusEl.className = `status-msg status-${type}`; 
        statusEl.style.display = 'block'; 
    } 
 
    function resetButtons(loginBtn, signupBtn, loginSpinner, signupSpinner, type) { 
        if(type === 'login') { 
            loginBtn.disabled = false; 
            loginSpinner.style.display = 'none'; 
            loginBtn.innerHTML = 'LOGIN'; 
        } else { 
            signupBtn.disabled = false; 
            signupSpinner.style.display = 'none'; 
            signupBtn.innerHTML = 'SIGN UP'; 
        } 
    } 
 
    // PERFECT PEERJS CONNECTION - Fixed NAT & Retry Logic 
    function initPeer() { 
        if(peer) { 
            peer.destroy(); 
        } 
         
        const config = { 
            host: '0.peerjs.com',  // Cloud server - reliable for testing 
            port: 443, 
            path: '/peerjs', 
            secure: true, 
            debug: 2,  // Moderate logging 
            config: {  
                iceServers: [ 
                    {urls: 'stun:stun.l.google.com:19302'},  // Google STUN 
                    {urls: 'stun:stun1.l.google.com:19302'}, // Backup STUN 
                    // Add TURN if needed: {urls: 'turn:your-turn-server.com:3478', username: 'user', credential: 'pass'} 
                ], 
                iceTransportPolicy: 'all'  // Try relay if direct fails 
            } 
        }; 
         
        peer = new Peer('ARCH-' + currentUser, config); 
        isConnected = false; 
         
        // Connection events 
        peer.on('open', id => { 
            console.log('Peer connected with ID:', id); 
            showConnectionStatus('Connected: ' + id, 'success'); 
            isConnected = true; 
        }); 
         
        peer.on('connection', c => {  
            conn = c;  
            currentMode = 'online'; 
            playerColor = 'b'; 
            setupConnection();  
            document.getElementById('p1-label').innerText = conn.peer.replace('ARCH-',''); 
            document.getElementById('p2-label').innerText = currentUser; 
            showConnectionStatus('Opponent connected: ' + conn.peer.replace('ARCH-',''), 'success'); 
            startGame(); 
        }); 
         
        peer.on('error', err => { 
            console.error('Peer error:', err); 
            showConnectionStatus('Connection error: ' + err.type + '. Retrying...', 'error'); 
            if(err.type === 'network' || err.type === 'timeout') { 
                setTimeout(initPeer, 5000); 
            } 
        }); 
         
        peer.on('disconnected', () => { 
            console.log('Peer disconnected, reconnecting...'); 
            showConnectionStatus('Disconnected. Reconnecting...', 'error'); 
            setTimeout(initPeer, 3000); 
        }); 
         
        // Heartbeat 
        setInterval(() => { 
            if(conn && conn.open) { 
                try { 
                    conn.send({type: 'ping'}); 
                } catch(e) { 
                    console.error('Heartbeat failed:', e); 
                } 
            } 
        }, 30000); 
    } 
 
    function showConnectionStatus(message, type) { 
        const statusEl = document.getElementById('connection-status'); 
        if(statusEl) { 
            statusEl.textContent = message; 
            statusEl.className = `status-msg status-${type}`; 
            statusEl.style.display = 'block'; 
            setTimeout(() => statusEl.style.display = 'none', 5000); 
        } 
    } 
 
    // AI Engine - Enhanced Minimax 
    function orderMoves(moves, g) { 
        return moves.sort((a, b) => { 
            const capA = g.is_capture(a); 
            const capB = g.is_capture(b); 
            if (capA !== capB) return capA ? -1 : 1; 
            const promA = a.promotion; 
            const promB = b.promotion; 
            if (promA && !promB) return -1; 
            if (!promA && promB) return 1; 
            return 0; 
        }); 
    } 
 
    function enhancedMinimax(g, maxDepth, alpha, beta, isMax) { 
        let best = -Infinity; 
        const orderedMoves = orderMoves(g.moves(), g); 
         
        for (let depth = 1; depth <= maxDepth; depth++) { 
            const val = minimaxHelper(g.clone(), depth, alpha, beta, isMax); 
            if (val > best) best = val; 
            if (beta <= alpha) break; 
        } 
        return best; 
    } 
 
    function minimaxHelper(g, depth, alpha, beta, isMax) { 
        if (depth === 0 || g.game_over()) return -evaluateBoard(g); 
         
        const moves = orderMoves(g.moves(), g); 
        if (isMax) { 
            let best = -Infinity; 
            for (let m of moves) { 
                g.move(m); 
                best = Math.max(best, minimaxHelper(g, depth - 1, alpha, beta, false)); 
                g.undo(); 
                alpha = Math.max(alpha, best); 
                if (beta <= alpha) break; 
            } 
            return best; 
        } else { 
            let best = Infinity; 
            for (let m of moves) { 
                g.move(m); 
                best = Math.min(best, minimaxHelper(g, depth - 1, alpha, beta, true)); 
                g.undo(); 
                beta = Math.min(beta, best); 
                if (beta <= alpha) break; 
            } 
            return best; 
        } 
    } 
 
    const pst = { 
        p: , 
        n: [-50,-40,-30,-30,-30,-30,-40,-50,-40,-20, 0, 5, 5, 0,-20,-40,-30, 5, 10, 15, 15, 10, 5,-30,-30, 0, 15, 20, 20, 15, 0,-30,-30, 5

